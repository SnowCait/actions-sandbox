name: PR diff

on:
  pull_request:
    paths:
      - .github/workflows/diff.yml

jobs:
  diff:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      GH_TOKEN: ${{ github.token }}
      GH_REPO: ${{ github.repository }}
      number: ${{ github.event.number }}
    steps:
      - run: gh pr diff ${number}
      - run: gh pr diff ${number} --name-only
      
      - run: |
          json=$(curl -sS \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${number})
          echo "${json}" | jq -r '.diff_url'
          curl -sS -L $(echo "${json}" | jq -r '.diff_url')

      - run: |
          curl -sS \
            -H "Accept: application/vnd.github.v3.diff" \
            -H "Authorization: Bearer ${token}" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${number}
        env:
          token: ${{ github.token }}

      - run: |
          curl -sS \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${token}" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${number}/files \
            | jq -r '.[].filename'
        env:
          token: ${{ github.token }}

      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - run: git diff origin/${GITHUB_BASE_REF}...origin/${GITHUB_HEAD_REF}
      - run: git diff origin/${GITHUB_BASE_REF}..origin/${GITHUB_HEAD_REF}
      - run: git diff origin/${GITHUB_BASE_REF} origin/${GITHUB_HEAD_REF}
      - run: git diff --name-only origin/${GITHUB_BASE_REF}...origin/${GITHUB_HEAD_REF}
      - run: git diff --name-only origin/${GITHUB_BASE_REF}..origin/${GITHUB_HEAD_REF}
      - run: git diff --name-only origin/${GITHUB_BASE_REF} origin/${GITHUB_HEAD_REF}

      - uses: tj-actions/changed-files@v34
        id: changed-files
      - run: echo "${json}"
        env:
          json: ${{ toJSON(steps.changed-files.outputs) }}

      - uses: jitterbit/get-changed-files@v1
        id: files
      - run: echo "${json}"
        env:
          json: ${{ toJSON(steps.files-outputs) }}
