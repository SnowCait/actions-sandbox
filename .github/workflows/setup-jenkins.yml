name: Setup Jenkins

on:
  push:
    paths:
      - .github/workflows/setup-jenkins.yml
      - jenkins/**
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v3
      - uses: snow-actions/setup-jenkins@main
        with:
          jenkins_home: jenkins/jenkins_home
      - run: curl --head http://localhost:8080/
      - run: ls -la jenkins/jenkins_home/
      - run: ls -la jenkins/jenkins_home/jobs/
      
      # Remote Access API
      - run: |
          crumb=$(curl -s -c cookie http://localhost:8080/crumbIssuer/api/json)
          echo "CRUMB_HEADER=$(echo $crumb | jq -r '.crumbRequestField'): $(echo $crumb | jq -r '.crumb')" >> $GITHUB_ENV
      - run: curl -X POST -H "${CRUMB_HEADER}" -b cookie http://localhost:8080/api/json | jq '.jobs'
      - run: curl -X POST -H "${CRUMB_HEADER}" -b cookie http://localhost:8080/job/job-1/build
      
      # Jenkins CLI
      - run: wget http://localhost:8080/jnlpJars/jenkins-cli.jar
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket help
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket version
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket who-am-i
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket list-jobs
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket build job-1
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket get-job job-1
      - run: sleep 10s
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket console job-1 -f
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket build job-1 -f -v
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket build job-1 -f -v -p pr_number=200
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket list-plugins
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket list-plugins http_request
        continue-on-error: true
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket install-plugin http_request -deploy
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket list-plugins
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket list-plugins http_request
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket copy-job job-1 job-2
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket list-jobs
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket build job-2 -f -v -p pr_number=201
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket create-job job-3 < jenkins/job-3/config.xml
      - run: java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket build job-3 -f -v -p param_1=p1
      - run: |
          echo 'jenkins.model.Jenkins.instance.items.each { job -> println "Name: ${job.name}" }' | java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket groovy '='
      - run: |
          java -jar jenkins-cli.jar -s http://localhost:8080/ -webSocket groovy 'jenkins.model.Jenkins.instance.items.each { job -> println "Name: ${job.name}" }'
      
      # Info
      - run: printenv
      - run: docker ps
      - run: docker compose ps
      - run: docker compose run --rm jenkins --version
