name: Git Commands

on:
  push:
    paths: .github/workflows/git.yml
  workflow_dispatch:

jobs:
  first:
    if: false
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.changes.outputs.count > 0 }}
    
    steps:
    - uses: actions/checkout@v2.3.4
      with:
        ref: feature/git-commands
    - run: git remote -v
    - name: git config の代替
      uses: dawidd6/action-git-user-config@v1.0.0
#     - name: git config
#       run: |
#         git config user.email email@example.com
#         git config user.name example
    - run: mkdir -p files
    - run: |
        #echo 'content' >> files/file.txt
        #echo 'content2' >> files/file2.txt
        git diff --name-only
    - run: echo "::set-output name=count::$(git diff --name-only | wc -l)"
      id: changes
    - run: echo ${{ steps.changes.outputs.count > 0 }}
    - run: git diff --name-only
      if: steps.changes.outputs.count > 0
    - run: |
        git add -A
        git commit -m 'try commit'
        git push
      if: steps.changes.outputs.count > 0

  second:
    runs-on: ubuntu-latest
    needs: [first]
    
    steps:
      - run: echo ${{ needs.first.outputs.changed }}
      - run: echo "true"
        if: needs.first.outputs.changed
    
  exit-code:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - run: cat $GITHUB_EVENT_PATH
      - uses: actions/checkout@v2.3.4
        with:
          ref: feature/git-commands
      - run: mkdir -p files
#       - name: Write
#         run: |
#           echo 'content' >> files/file.txt
#           echo 'content2' >> files/file2.txt
      - run: git diff
      - run: git diff --name-only --exit-code
        id: diff
        continue-on-error: true
      - name: git config
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
      - run: |
          set -x
          git add -A
          git commit --author "${author}" -m 'commit'
          git push
          git log -1
          git log -1 --pretty=full
        if: steps.diff.outcome == 'failure'
        env:
          author: ${{ github.event.head_commit.author.name }} <${{ github.event.head_commit.author.email }}>
